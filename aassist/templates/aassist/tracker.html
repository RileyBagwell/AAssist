<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8"/>
    <title>AAssist | Drink Tracker</title>
    {% load static %}
    {% load bootstrap5 %}
    {% bootstrap_css %}
    {% bootstrap_javascript %}
    <link rel="stylesheet" href="{% static 'aassist/style.css' %}?v=1.1">
</head>

<body>
    {% include "includes/navbar.html" %}
    
    <div class="tracker-container">
        <div class="container-fluid">
            <h1 class="mb-4">Drink Tracker</h1>
            
            {% if not user.is_authenticated %}
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading">Login Required</h4>
                <p>You need to be logged in to use the drink tracker. Please <a href="{% url 'login' %}" class="alert-link">login</a> or <a href="{% url 'register' %}" class="alert-link">create an account</a> to get started.</p>
            </div>
            {% else %}
            
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="stats-card">
                        <h5>Total Alcohol Units (30 days)</h5>
                        <h2>{{ total_alcohol_units }}</h2>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card">
                        <h5>Total Calories (30 days)</h5>
                        <h2>{{ total_calories }}</h2>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stats-card">
                        <h5>Drinks Consumed (30 days)</h5>
                        <h2>{{ recent_consumption|length }}</h2>
                    </div>
                </div>
            </div>

            <!-- Search Section -->
            <div class="search-section">
                <h3>Search & Add Drinks</h3>
                <div class="row">
                    <div class="col-md-8">
                        <input type="text" id="drinkSearch" class="form-control" placeholder="Search for drinks by name, category, or description..." autocomplete="off">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="searchDrinks()">Search</button>
                    </div>
                </div>
                
                <!-- Search Results -->
                <div id="searchResults" class="search-results mt-3"></div>
            </div>

            <!-- Recent Consumption -->
            <div class="row">
                <div class="col-12">
                    <h3>Recent Consumption</h3>
                    <div id="consumptionList">
                        {% for consumption in recent_consumption %}
                        <div class="consumption-item" data-consumption-id="{{ consumption.id }}">
                            <div>
                                <strong>{{ consumption.drink.name }}</strong>
                                <span class="badge bg-secondary ms-2">{{ consumption.drink.get_category_display }}</span>
                                <br>
                                <small class="text-muted">
                                    {{ consumption.consumed_at|date:"M d, Y H:i" }} • 
                                    Quantity: {{ consumption.quantity }} • 
                                    {{ consumption.total_alcohol_units }} units • 
                                    {{ consumption.total_calories }} cal
                                </small>
                                {% if consumption.notes %}
                                <br><small class="text-info">{{ consumption.notes }}</small>
                                {% endif %}
                            </div>
                            <button class="btn-delete" onclick="deleteConsumption({{ consumption.id }})">Delete</button>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-4">
                            <p>No drinks consumed yet. Search and add your first drink!</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        let searchTimeout;

        // Search drinks with debouncing
        document.getElementById('drinkSearch').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            if (query.length < 2) {
                document.getElementById('searchResults').classList.remove('show');
                return;
            }
            
            searchTimeout = setTimeout(() => {
                searchDrinks(query);
            }, 300);
        });

        async function searchDrinks(query = null) {
            const searchInput = document.getElementById('drinkSearch');
            const queryText = query || searchInput.value.trim();
            
            if (!queryText) {
                document.getElementById('searchResults').classList.remove('show');
                return;
            }

            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="loading">Searching...</div>';
            resultsDiv.classList.add('show');

            try {
                const response = await fetch('/api/search-drinks/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ query: queryText })
                });

                const data = await response.json();
                displaySearchResults(data.drinks);
            } catch (error) {
                resultsDiv.innerHTML = '<div class="text-danger">Error searching drinks. Please try again.</div>';
            }
        }

        function displaySearchResults(drinks) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (drinks.length === 0) {
                resultsDiv.innerHTML = '<div class="text-muted p-3">No drinks found. Try a different search term.</div>';
                return;
            }

            let html = '';
            drinks.forEach(drink => {
                html += `
                    <div class="drink-card">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h6 class="mb-1">${drink.name}</h6>
                                <small class="text-muted">
                                    ${drink.category} • ${drink.alcohol_content}% ABV • ${drink.volume_ml}ml • 
                                    ${drink.alcohol_units} units • ${drink.total_calories} cal
                                </small>
                                ${drink.description ? `<br><small class="text-info">${drink.description}</small>` : ''}
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="mb-2">
                                    <input type="number" class="form-control form-control-sm quantity-input d-inline-block" 
                                           value="1" min="1" max="10" id="qty-${drink.id}">
                                    <input type="text" class="form-control form-control-sm notes-input d-inline-block" 
                                           placeholder="Notes (optional)" id="notes-${drink.id}">
                                </div>
                                <button class="btn-add-drink" onclick="addDrink(${drink.id})">
                                    Add Drink
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

        async function addDrink(drinkId) {
            const quantity = document.getElementById(`qty-${drinkId}`).value;
            const notes = document.getElementById(`notes-${drinkId}`).value;

            try {
                const response = await fetch('/api/add-consumption/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        drink_id: drinkId,
                        quantity: parseInt(quantity),
                        notes: notes
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    // Add to consumption list
                    addConsumptionToList(data.consumption);
                    
                    // Clear search
                    document.getElementById('drinkSearch').value = '';
                    document.getElementById('searchResults').classList.remove('show');
                    
                    // Show success message
                    showAlert('Drink added successfully!', 'success');
                } else {
                    showAlert('Error adding drink: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Error adding drink. Please try again.', 'danger');
            }
        }

        function addConsumptionToList(consumption) {
            const consumptionList = document.getElementById('consumptionList');
            const emptyMessage = consumptionList.querySelector('.text-center');
            
            if (emptyMessage) {
                emptyMessage.remove();
            }

            const consumptionItem = document.createElement('div');
            consumptionItem.className = 'consumption-item';
            consumptionItem.setAttribute('data-consumption-id', consumption.id);
            
            consumptionItem.innerHTML = `
                <div>
                    <strong>${consumption.drink_name}</strong>
                    <br>
                    <small class="text-muted">
                        ${consumption.consumed_at} • 
                        Quantity: ${consumption.quantity} • 
                        ${consumption.total_alcohol_units} units • 
                        ${consumption.total_calories} cal
                    </small>
                    ${consumption.notes ? `<br><small class="text-info">${consumption.notes}</small>` : ''}
                </div>
                <button class="btn-delete" onclick="deleteConsumption(${consumption.id})">Delete</button>
            `;
            
            consumptionList.insertBefore(consumptionItem, consumptionList.firstChild);
        }

        async function deleteConsumption(consumptionId) {
            if (!confirm('Are you sure you want to delete this drink consumption?')) {
                return;
            }

            try {
                const response = await fetch(`/api/delete-consumption/${consumptionId}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    const item = document.querySelector(`[data-consumption-id="${consumptionId}"]`);
                    if (item) {
                        item.remove();
                    }
                    showAlert('Drink consumption deleted successfully!', 'success');
                } else {
                    showAlert('Error deleting consumption: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Error deleting consumption. Please try again.', 'danger');
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 100px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Close search results when clicking outside
        document.addEventListener('click', function(event) {
            const searchResults = document.getElementById('searchResults');
            const searchInput = document.getElementById('drinkSearch');
            
            if (!searchResults.contains(event.target) && !searchInput.contains(event.target)) {
                searchResults.classList.remove('show');
            }
        });
    </script>
</body>
</html>